from flask import Flask, request, jsonify
from flask_cors import CORS
from pymongo import MongoClient
from datetime import datetime

app = Flask(__name__)
CORS(app)

# ✅ Connect to MongoDB
client = MongoClient("mongodb://127.0.0.1:27017/")
db = client["smartwater"]
collection = db["waterdata"]

# ✅ POST API → Add water data
@app.route("/api/water", methods=["POST"])
def add_water_data():
    try:
        data = request.json
        data["timestamp"] = datetime.now()
        collection.insert_one(data)
        return jsonify({"message": "Data saved successfully"}), 201
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# ✅ GET API → Fetch last 10 records
@app.route("/api/water", methods=["GET"])
def get_water_data():
    try:
        cursor = collection.find().sort("timestamp", -1).limit(10)
        result = []
        for doc in cursor:
            doc["_id"] = str(doc["_id"])  # convert ObjectId to string
            result.append(doc)
        return jsonify(result[::-1])  # reverse for oldest→latest order
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    app.run(debug=True, port=5000)
